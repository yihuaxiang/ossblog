# 如何在 NGINX 中配置缓存控制头

![](https://fudongdong-statics.oss-cn-beijing.aliyuncs.com/images/20220430/541461df6dca45498a9960f79f9a7de8.png?x-oss-process=image/auto-orient,1/interlace,1/quality,q_50/format,jpg)


缓存是存储下载数据以供以后使用的过程，可以从磁盘读取数据，而不是再次请求。正确使用浏览器和 CDN 缓存可以显着加快您的网站速度。


### 缓存如何工作？


每个用户的浏览器都有一个内置缓存，用于存储从网站下载的静态对象。下次连接时，如果他们请求的对象仍在缓存中，它将从内存中加载而不是再次请求，从而显着提高性能并减少此过程中 Web 服务器的负载。

用户的浏览器是一个客户端缓存。但是，许多大型站点也将使用内容交付网络或 CDN。CDN 位于您的 Web 服务器前面，并将您的页面缓存在服务器端，通常位于世界各地的多个边缘服务器上。这可以改善访问延迟和性能，并大大减轻您的 Web 服务器的压力。如果您想了解有关 CDN 的更多信息，可以在此处阅读我们的指南。

Cache-Control 是一个标头，您可以将 Web 服务器配置为添加到所有传出请求中。使用它，您可以指定缓存哪些资源以及缓存多长时间。在您在站点范围内添加它之前，有一些事情需要注意。

某些页面 永远不应该被缓存。任何需要用户登录的内容都不应被 CDN 缓存，否则您将面临将一个用户的个人信息显示给其他人的风险。您仍然可以单独在浏览器端缓存这些类型的页面（通过设置Cache-Control 为private）。作为一般规则，如果页面对于所有用户来说都是完全相同的，比如你的主页，你可以缓存它。静态资源，如 CSS 和图像，通常可以被缓存，而且缓存时间通常更长。

您还需要确保为每个资源设置合理的生存时间 (TTL) 值。TTL 控制对象在失效前将在缓存中停留多长时间，提示用户请求新对象。这里的权衡是在较长的缓存时间和快速更新之间。您不想将主页缓存一整年，因为您可能会在星期二更改某些内容。为您的主页设置大约几分钟的最大使用时间足以涵盖立即重新加载，并且足够快以允许快速传播更新。但是，对于像图像这样的静态资源，它们可能永远不会改变，你应该可以设置高 TTL 值，甚至高达两年。

您始终可以使用版本化文件名来触发缓存重新加载。如果发布新版本的 CSS 样式表，可以将其命名为styles-1.0.1.css，用户的浏览器（以及它前面的任何 CDN）会将其视为需要重新下载的新文件。此外，对于某些 CDN，您可以发出手动失效以刷新现有缓存而不更改任何文件名。


### 如何在 NGINX 中使用缓存控制


Cache-Control有几个选项：

1. public – 可能被任何人缓存，包括浏览器和 CDN。将其用于大多数静态对象。
2. private – 包含 CDN 或反向代理无法缓存的敏感数据。用户的浏览器可能会在本地缓存它。将此用于大多数经过身份验证的页面。
3. no-cache – 尽管有名称，但它不会禁用缓存。浏览器可能仍会缓存响应以提高性能，但必须在使用前与源服务器检查更新。如果您希望用户每次都重新验证，请使用此选项
4. no-store – 完全禁用缓存。仅将其用于不应发送两次的高度敏感数据。


设置时max-age，总是在几秒钟内完成。然而，NGINX 允许更多的自定义值：

1. -1, 或off, 这将关闭缓存，并且不修改现有的标头
2. epoch，设置为 Unix 时间零，这将显式关闭缓存并清除所有缓存（如果您使用 NGINX 作为反向代理，则很有用）
3. max，将在宇宙结束时到期，2037 年 12 月 31 日
4. 30s, 几秒钟
5. 1m, 分钟
6. 24h， 用了几个小时
7. 3d， 持续数天
8. 1M, 几个月
9. 2y， 多年

此外，您可以添加 no-transform 指令，该指令禁用可能对资源进行的任何转换。例如，一些 CDN 压缩图像以减少带宽。该指令禁用该行为。

对于 NGINX，您可以使用以下指令修改 Cache-Control 标头：

```nginx
expires 1y;
add_header Cache-Control "public, no-transform";
```

第一行将 max-age 设置为 1 年，第二行设置public 和no-transform 缓存设置。您可以将其添加到server 块中以在站点范围内应用，但更好的方法是将文件扩展名与位置块匹配，以根据文件扩展名设置不同的值：

```nginx
location ~* .(?:css|js)$ {
  expires 1y;
  add_header Cache-Control "public";
}
```

此位置块使用正则表达式匹配，由~. 这对于应用内容类型的常规设置很有用。如果要对特定位置进行例外处理，可以使用常规位置块，该块将优先于正则表达式匹配。

```nginx
location /profile {
    expires 2d;
    add_header Cache-Control "public, no-transform";
}
```

您还可以使用 = 修饰符，它与路径完全匹配，并且优先于正则表达式匹配和标准位置块。

### 使用 Surrogate-Control 修改 CDN 行为


虽然您可以禁用 CDN 缓存并仍然通过使用来利用浏览器缓存Cache-Control: private，但最好直接控制它。大多数 CDN 将尊重Surrogate-Control 标头，其功能与 完全相同Cache-Control，只是仅适用于 CDN。这样，您可以告诉 Fastly 做一件事，让用户做另一件事。

在 NGINX 中，您必须手动设置此标头，并设置max-age 值而不是使用 NGINX 的expires 指令。


```nginx
add_header Surrogate-Control "public, max-age=86400";
add_header Cache-Control "public, max-age=120";
```

您肯定会希望使用您的 CDN 进行测试，以验证这是否有效——这Surrogate-Control 是相当新的，并且不是通用的。
